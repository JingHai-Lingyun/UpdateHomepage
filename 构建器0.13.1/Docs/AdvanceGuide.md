# 构建器进阶教程
## 资源文件
资源文件是构建器用于样式匹配，模版调用等功能的文件，如果说构建器是一个火柴盒那么资源文件就是里边的内饰。

目前资源文件主要包括以下部分：

* Components - 构件
* Scripts - 脚本
* Templates - 模版
* Styles - 样式

### 细说主页的生成

在基础教程我们提到，主页的构建只有三个步骤：

1. 找到页面需要的卡片
2. 生成卡片的 XAML 代码
3. 按顺序将 XAML 代码堆在一起

这是主页构建器最基本的逻辑，但是步骤二未免有点太泛泛了，主页构建器到底是如何生成 XAML 卡片的呢

我们就拿基础教程里使用的 Hello World 卡片来举例：

在第一步结束后，构建器已经找到了我们想要的卡片，这时候的卡片其实是一个包含多样键值的字典，我们称之为卡片属性：

```JSON
{
    "templates": ["MarkdownCard"],
    "data": "# 我的第一张卡片
    ## EXAMPLE
    > 越过长城，走向世界！
    
    * Hello World!
    * Bonjour Le Monde!
    * Ciao Mondo！", 
    "file_name": "HelloWorld",
    "file_exten": "md"
}
```

主页构建器要处理的卡片多种多样，那么如何知道这个卡片应该长什么样，就用的是这里 `template` 的值

#### 模版
`template` 是个列表，当构建主页时，构建器会从上到下查找这个卡片符合哪个个条件，并使用第一个符合条件的模版来构建主页

我们现在打开这个`MarkdownCard`模版来看一眼这个模版里都有啥:

```YAML
components:
 - $MarkdownPresenter
base: FlowDocCard
fill:
  title: ${$GetMdH1}
filter:
  file_exten:
    - md
    - markdown
```

##### 构件
`components` 就是我们刚才提到的构件，主页构建器认为卡片是由多个构件构成的，构件就是构成卡片和主页的最基本单元。

在模版里的构件是一个列表，表示这个模版内容是由这几个构件构成的。主页生成器在生成主页的时候就是像构建整个页面一样，先生成这几个构件的代码，然后套模版。这就是整个卡片的生成逻辑。

如你所见，这个模版的构件只有一个：`$MarkdownPresenter`，在主页构建器里，任何以 `$` 开头的东西都代表了这个东西是一个脚本（script）。`MarkdownPresenter` 这个脚本的作用就是将卡片的 Markdown 代码转换成一个构件。

除了这些特殊的脚本驱动的构件，构建器还有一般的构件，这些是纯 xaml 代码，写在 `Resources/Components` 这个文件夹里，感兴趣可以自己查看。

##### 模版继承
很多模版都需要卡片这个元素，如果在每个模版中都写入一张卡片，如果最后要修改这张卡片，那么需要把所有使用卡片的模版都修改一遍，完全不利于维护。所以构建器给模版引入了继承关系。

`base` 这个字段就是表示模版的父级是什么模版，下面是`MarkdownCard`模版的继承关系：

`CardFrame -> Card -> FlowDocCard -> MarkdownCard`

所谓继承，其实也是一环套一环：`CardFrame` 是整个卡片的最外边的元素；`Card` 在 `CardFrame` 的基础上填充了一个 `StackPanel` 使其可以展示多个 XAML 元素并控制了内容与卡片边界的距离；`FlowDocCard` 向 Card 的内容里放入了一个流文档阅读器，Markdown 就是构建器转成流文档再呈现的。

##### 模版筛选

上边说到模版需要筛选，如何筛选是由 `filter` 定义的，我们回到我们的例子：

```YAML
filter:
  file_exten:
    - md
    - markdown
```

卡片在这时不是字典吗，这个 `filter` 的作用匹配键是否符合这个值。比如这个就是匹配 `file_exten`（文件扩展名）是否是 `md` 或 `markdown` 的其中一个，如果是则匹配成功。

##### 内置的模版

主页构建器已经内置了几个模版，当你构建的时候就不需要重新写这些模版（除非你有自己的需求）


|模版名称|描述|匹配规则|
|----|----|----|
|`CardFrame`|只有卡片元素的框架，其中只能放入一个 Xaml 元素|*仅用于继承*|
|`Card`|可以以列表呈现 Xaml 元素内容的卡片，卡片的最基本形态|*仅用于继承*|
|`FlowDocCard`|有流文档阅读器的卡片|*仅用于继承*|
|`Raw`|纯 Xaml，没有卡片框架的模版|匹配 .xaml 文件|
|`RawCard`|套在卡片框架下的纯 Xaml|匹配 .xaml 文件|
|`MarkdownCard`|呈现 Markdown 内容的卡片 *(插件扩展)*|匹配 .md .markdown 文件

##### 其他属性

模版还支持一些其它的属性，请查询模版的 Wiki 页面

#### 卡片属性

卡片属性就是上边的那个字典，可见模版是卡片属性的其中一个。我们如何将属性填写到卡片里？还记得我们在基础教程的卡片库有一个没有讲的地方吗？

``` YAML
name: rootLibrary # 卡片库的名称，你可以随意更改
fill: # 这些内容在进阶教程会有讲解，现在照做就好。 
   templates:
    - MarkdownCard
```

你可能猜到了，这个 `fill` 就是用来将属性填写进卡片里的。在库里的`fill`会将其库所有对应键上没有值的填入值。额？听不懂？下边是个例子：

TODO 一个例子

`fill` 目前可以填写在两个位置：库处和模版处，在执行 fill 操作的时候会优先填库的

事实上，除了 `fill` 还有其它两种方法可以填写属性

##### cover

`cover` 和 fill 差不多，但 cover 是强制将属性值覆盖，并且执行 cover 操作的时候，优先使用模版的覆盖

##### 页面定义属性

除了在库和模版处定义属性，你可以在页面处定义属性

TODO 例子

上边的代码就是将`ATTR1`设为`VALUE1`，这个通常用来设置卡片是否折叠与特例

#### 扩展占位符
为了保障模版与卡片的可复用性和扩展性，你可以在卡片内容和卡片属性的任意地方写如同这样的占位符：`${place_holder}`，在主页构建过程中，构建器会尝试获取卡片`place_holder`这个名字的属性，将这个占位符替换成属性对应的值。

如果这个值没有被设定过，主页构建器将会保留这个占位符并抛出警告。你可以通过定义默认值禁用这一行为。下面是个例子：

`${title|DEFAULT TITLE}`，当构建器获取不到`title`的值时，它会填入`DEFAULT TITLE`这个值
